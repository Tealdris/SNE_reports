###### tags: `OT`
:::success
# OT Lab 4 Assignment: Malware analysis (test)
**Name: Radomskiy Ilia**
:::

---

## Task 1: Set up your environment.

:::info
1. Prepare and secure malware analysis environment for example FLARE VM. Make sure that VM uses a HOST ONLY network adapter.
2. Use any virtualization environment, better to use the latest version (check repo and official website).
3. Or you can create a Virtual Machine and set it up as a malware analysis environment.
:::

For this lab, I will prepare VM using `KVM` virtualization, in `VMM`. After that, i will download and install `win10` as a virtual machine
After OS is installed, I need to prepare it for the `FLARE` environment: disable windows defender, and make all necessary updates
In `powershell` console I need to specify `Set-ExecutionPolicy Unrestricted` in order to proceed
Then make the installation file of the `FlareVM` possible to execute with `Unblock-File .\install.ps1`
After a long process of installation and several reboots, the environment is settled up and ready [1]

<center>

![](https://i.imgur.com/LZVJc4Z.png)
    
</center>

---

## Task 2: Letâ€™s get some malware

:::info
1. Download some malware/ransomware from the Internet (for example, TheZoo repo). Please be careful when you run them, THESE ARE REAL MALWARE.
2. Select at least two malware that you want to analyze in a malware analysis environment.
:::

Malware can be downloaded from several sources, like `Malware bazar`[2], of Github repository `thezoo`[3].
I will analyze malware, taken from the `the zoo`

1. Dexter malware

<center>
    
![](https://i.imgur.com/XvsEaEB.png)

</center>

---
## Task 3: Static Analysis

:::info
1. Use any tool for static analysis of your selected malware (for example, Ghidra, IDA,Binary Ninja, Hopper, Radare2, ...).
:::

1. Dexter in `PEstudio`

First of all quick overview of the PE file.
It is a 32-bit executable
And we already can see from the `PEstudio` , that program is using some the dangerous libraries and function
Additionally, this executable is self-modifying, which means, it can overwrite itself, to make it harder to detect. May be mimicking the normal process

<center>
    
![](https://i.imgur.com/sko6Bdg.png)
    
</center>

Unfortunately, `PEstudio` gives us information without structure, so we might continue in the disassembler, in order to specify get more information about the malware.
I will be using `IDA` for the disassembly analysis


1. Dexter

The program itself is quite big, but it can be divided into several parts
First, mutex establishment.
`Mutexes` is used in order to prevent multiple access to one resource during parallel execution.
Malware often uses mutexes as a mark on the infected machine, if there is one, virus will not spoil this machine

In the first 3 block, we are: getting info about the machine, setting up variables, and getting information about the `mutexes`, if the machine is infected we are going to the next, second stage
If now, a new `mutex` is created

<center>

![](https://i.imgur.com/DKzb9WY.png)
    
</center>

In this picture, more functions are related to the mutex creation, with setting attributes for them.

<center>

![](https://i.imgur.com/x9vTfcn.png)
    
</center>

If everything is fine with it we can proceed with the infiltration

<center>

![](https://i.imgur.com/2WPHxxH.png)

</center>

After work with the `mutexes` is done malware starts to gather information from the system
The whole process of gathering is quite big, it goes into different locations, checks

<center>

![](https://i.imgur.com/Dkg9MGi.png)
Saving information about computer parameters, calls and savings

![](https://i.imgur.com/g8bDuJx.png)
Division based on process id, if yes continue, if no perform further infiltration
</center>

On this stage writing to the registers happens for making a more persistent environment for the malware

<center>

![](https://i.imgur.com/5MUrGXI.png)

</center>

Those two function calls are expanded on the big functions with the register changing

<center>

![](https://i.imgur.com/xAePphB.png)
    
</center>

After that biggest stage with the data collection is happening. This function, full of calls and writing to the memory, used as a main information gathering chunk of the malware

<center>

![](https://i.imgur.com/tyN0ZnL.png)
    
</center>

Last thing, the malware opens a connection to the malicious server and sends the information to the attacker

<center>

![](https://i.imgur.com/nJfpU3N.png)

</center>

After the last stage malware is either go to sleep mode, or exits itself.


:::info
2. Now try to use other online tools (for example, any.run, hybrid analysis, ...), upload the malware and see what artifact it detects.
:::

In our case malware is well known, so it will be recognized immediately. Antiviruses are using samples of the known malware to create protection against them. If the malware is new, then the sandbox will be using another approach to identify it, for example, if the program is using cryptography, then it might be a signal os aware
Online tools for the malware analysis represent themselves as sandboxes, of virtual and protected environments. THis environment is monitored, in order to tell the user what kind of malicious actions were performed by the executable

1. **Dexter**

1.1 **Anyrun**

Let's start with the uploading of the sample on the website.
After the same time, we can see the results. In the picture below you can see shortlisted results.

1 Program was categorized, it is `trojan` and `stealer`, also, it is well-known malware, so we can see its name - `dexter`
2 We can see processes that were started by the malware. There is a chain of the creation processes, as we can remember, this process is self-modifying. That tactic is user my malware creators in order to hide the malware, create legitimate processes from the dangerous executable


<center>

![](https://i.imgur.com/hXLKZJ6.png)
    
</center>

3 We can see open communication with the ip adress `151.248.115.107`. This ip address is associated with the dexter malware, and considered malicious by `virustotal`. This ip address is used to collect data from the infected computer. But now this address is ton active

<center>

![](https://i.imgur.com/AmqKCh6.png)

</center>

4 behavior graph of the executable is displayed below. File `iexplore` was downloaded from the C2 server, with the ip that was described above. That means malware also have some functionalities of the dropper

<center>

![](https://i.imgur.com/LZ0UX6M.png)
![](https://i.imgur.com/Rwcuzqo.png)

</center>

1.2 **Hybrid Analysis**

Sometimes we need to have another point of view on the malware. Different technologies can give different results. That is especially important when we doing some investigation on the new malware

First look gives us, same reuslts: this dexter malware, it is created to steal information from the infected machines

<center>

![](https://i.imgur.com/dBYH1WW.png)
    
</center>

Other results are the same: hashes, registry writing, connection with the malicious ip address, process hiding and data acquisition

<center>

![](https://i.imgur.com/cdoiQxc.png)
process hiding
    
![](https://i.imgur.com/gZscryp.png)
data acquisition
</center>

:::info
3. Compare the findings of both methods, and see if there are some artifacts that online tools did not manage to find, or vice versa. For example, a piece of code or information that helps you in your analysis.
:::

Unfortunately, this peace of malware is too well studied, by the professional cybersecurity specialists. Because of this reason, i couldn't find any additional, or helpful piece of code, or something similar.
But, if we speaking about the completely new malware, we have to use any online tools only as a basic recon tool. This new malware even may be not recognized by the sandbox. Any further investigation has to be done with the help of the advanced reverse engineering tools, like Debugger.

:::info
4. Try to describe which method is better (Sandboxing V.S. Static analysis) is better, and which one is more useful in which case.
:::

Why don't use both, if you can? For example, you can start your investigation from the Static analysis, and when you are stuck some were, help yourself with the Sandboxing results, or vice versa, make a plan with a sandbox report, of the general approach of the virus, and, then, dig into the details with the reverse engineering tools
But, if we speak about the business, then Sandboxing is winning, it is quicker and cheaper. If you run some critical services, like health equipment, or energy facilities, then you have to hire a cybersecurity team or pay the outsourced one, and then, they will work this out for you.

---
## Task 4: Mapping to ATT&CK mitre framework

:::info
Map the malware that you have selected to the ATT&CK MATRIX,
:::

1. Dexter

From the analysis above we can create ATT&CK MATRIX. This type of map is used as a part of the mission by creating more effective cybersecurity knowledge in the internet. This map gives to the other users i quick knowledge about the piece of malware, and they can use this short report as their tactics against new threat

In the picture below you can see my view on the `ATT&CK MATRIX` based on the dexter analysis

<center>

![](https://i.imgur.com/NaA8uHB.png)
    
</center>

Below you can see the `ATT&CK MATRIX` based on the analysis from the online tools. They are not completed, because the remote server is down at the moment of the report creation

<center>

![](https://i.imgur.com/QeihVNV.png)
Anyrun ATT&CK MATRIX
    
![](https://i.imgur.com/HcMGumV.png)
Hybrid analysis ATT&CK MATRIX

</center>

If we take a look on `ATT&CK MATRIX` that was created at the active time of malware, then we can notice different layout 

<center>

![](https://i.imgur.com/bbZP7zh.png)
Joesandbox ATT&CK MATRIX
    
</center>

---
## Task 5: **Bonus** - Dynamic Analysis

:::info
1. You will be creating your own Dynamic Malware analysis Environment (i.e Cuckoo).
2. Try to use some debugger to analyze the malware WHILE IT IS RUNNING, be careful where you will run this malware, the debugger that you select must have a remote debugging feature.
:::

For this task, I will install the `Cuckoo sandbox`. It is an application for creating a virtual and safe environment for malware analysis, Similar to online tools.
After a long and dishonest struggle with the cuckoo installation process [4], I have finally achieved my goals, and the cuckoo was installed on my workstation. The environment is looking like in the picture below

<center>

![](https://i.imgur.com/9tQ5M9M.png)

</center>

`Cuckoo` itself consists of several helpful applications like `volatility` framework, disassembler `distorm3`, and others
We can start the analysis by the uploading some malicious files, they can be simply drugs and dropped to the web page

<center>

![](https://i.imgur.com/bJY152N.png)
    
</center>

After that process of the analysis is starting, `cuckoo` sends a command to start the virtual machine, analysis report with the result is generated

<center>

![](https://i.imgur.com/52lOf5X.png)
    
</center>

In the report there same information as in the dynamic analysis from the online tools.

<center>

![](https://i.imgur.com/r9psNAR.png)

</center>

Some parts of the malware leave traces, that were captured by the `cuckoo`

<center>

![](https://i.imgur.com/PUhAfuz.png)
    
</center>

But, unfortunately, not all. After some time of the analysis process, the virtual machine loses network connection with the host. The interesting part is that two machines still have the ability to communicate with each other, but the `cuckoo` thinks otherwise

:::info
3. Try some debugger that will allow you to debug the whole operating system (for example, PyReBox).
4. What kind of benefit does this method have?
:::

Using your own sandbox environment makes analysis of the malware more beneficial. It is especially important because some of the online tools, or are not providing the ability to analyze x64 bit applications (anyrun), or blocks, depending on region (hybrid analysis). Also, configuring your own environment makes it possible to analyse very difficult types of malware, this type of malware often monitors the OS on the traces of virtualization or sandboxing. 
Additionally, it is possible to create addons for the tools like the `cuckoo`, and integrate them if you are skilled enough

---

## References

1. [Flare VM](https://github.com/mandiant/flare-vm)
2. [Malware Bazaar](https://bazaar.abuse.ch/)
3. [TheZoo](https://github.com/ytisf/theZoo)
4. [Cuckoo nstalation](https://github.com/ForeGuards/Cuckoo-Installation-Guide/blob/main/installation.txt)